language: ruby
sudo: false
cache:
  - bundler
  - apt
stages:
  - test
  - build
services:
  - redis-server
  - docker
addons:
  postgresql: "9.6"
jobs:
  include:
    - stage: test
      language: ruby
      rvm: 2.5.1
      services:
        - redis-server
      addons:
        postgresql: "9.6"
      env:
        - RACK_ENV=test
      before_script:
        - createdb ebicsbox_test
        - bundle exec bin/migrate
      script:
        - bundle exec rspec spec
    - stage: build
      language: minimal
      cache: false
      install: skip
      before_script:
        - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
      script:
        - docker build -t ebicsbox:latest .
        - docker tag ebicsbox:latest railslove/ebicsbox:latest
        - docker push railslove/ebicsbox:latest
      if: branch = master
    - stage: build
      language: minimal
      cache: false
      install: skip
      before_script:
        - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
      script:
        - docker build -t ebicsbox:${TRAVIS_TAG} .
        - docker tag ebicsbox:${TRAVIS_TAG} railslove/ebicsbox:${TRAVIS_TAG}
        - docker push railslove/ebicsbox:${TRAVIS_TAG}
      if: tag IS present
notifications:
  slack:
    on_success: always
    on_failure: always
    secure: T+A+w3m8OffyVJuCrzpYMkbRA5GEwP33XeyhLXmRwsFsyRV9yftuugH7zKfY095GffP0h2lyHzAsGbUIYwWQNfHbo8WoHWwll23isEvnunrEQvSPyXvdLNnYuKBlPQLviBhsFyAt67Etr9Blh0E4AjURxiMHIXWgJep2tgoo6bM=
